name: Step4 Code Review

on:
  pull_request_target:
    types: [opened, synchronize]
  issue_comment:
    types: [created]

jobs:
  claude-review:
    if: |
      (github.event_name == 'pull_request_target' && (
        contains(github.event.pull_request.title, 'step4') ||
        contains(github.event.pull_request.title, 'Step4') ||
        contains(github.event.pull_request.title, '4ë‹¨ê³„') ||
        contains(github.event.pull_request.labels.*.name, 'step4')
      )) ||
      (github.event_name == 'issue_comment' && 
       github.event.issue.pull_request && 
       contains(github.event.comment.body, '@claude review'))

    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 1

      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ap-northeast-2

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          use_bedrock: true
          timeout_minutes: '30'
          model: 'apac.anthropic.claude-sonnet-4-20250514-v1:0'

          # Direct prompt for automated review (no @claude mention needed)
          direct_prompt: |
            ## ğŸ¯ Step 4 ë¯¸ì…˜ ë‹¬ì„±ë„ ì¤‘ì‹¬ ë¦¬ë·° ê°€ì´ë“œë¼ì¸
            
            **ì´ ë¦¬ë·°ëŠ” Step 4 ë¯¸ì…˜ ìš”êµ¬ì‚¬í•­ ë‹¬ì„±ì— ì§‘ì¤‘í•©ë‹ˆë‹¤.**
            Thread Poolê³¼ ë™ì‹œì„± ì²˜ë¦¬ êµ¬í˜„ì„ ì¤‘ì ì ìœ¼ë¡œ ê²€í† í•˜ê³  **í•œê¸€ë¡œ** í”¼ë“œë°±ì„ ì œê³µí•´ì£¼ì„¸ìš”.
            **ì¤‘ìš”**: ìš”êµ¬ì‚¬í•­ êµ¬í˜„ë³´ë‹¤ Thread Poolì˜ ë™ì‘ ì›ë¦¬ ì´í•´ê°€ ë” ì¤‘ìš”í•©ë‹ˆë‹¤.
            
            ### ğŸ“š í•™ìŠµ ì›ì¹™
            - **ì§ì ‘ ì½”ë“œë¥¼ ì œê³µí•˜ì§€ ë§ˆì„¸ìš”** (í•™ìŠµìê°€ ëª…ì‹œì ìœ¼ë¡œ ìš”ì²­í•˜ëŠ” ê²½ìš° ì œì™¸)
            - **ë¬¸ì œ í•´ê²° ê³¼ì •ì„ ì•ˆë‚´**í•˜ë˜, ì •ë‹µì„ ë°”ë¡œ ì•Œë ¤ì£¼ì§€ ë§ˆì„¸ìš”
            - **ì‘ì€ ë‹¨ê³„ë¡œ ë¬¸ì œë¥¼ ë¶„í•´**í•˜ì—¬ ì ‘ê·¼í•˜ë„ë¡ ë„ì™€ì£¼ì„¸ìš”
            
            ### ğŸ’¡ í”¼ë“œë°± ë°©ë²•
            - **ìœ ë„ ì§ˆë¬¸ í™œìš©**: "ë§Œì•½ ~ë¼ë©´ ì–´ë–»ê²Œ ë ê¹Œìš”?", "~ë¥¼ ê³ ë ¤í•´ë³´ì…¨ë‚˜ìš”?"
            - **íŒíŠ¸ ì œê³µ**: ë°©í–¥ì€ ì œì‹œí•˜ë˜, êµ¬ì²´ì ì¸ êµ¬í˜„ì€ í•™ìŠµìê°€ í•˜ë„ë¡
            - **ë‹¤ì–‘í•œ ì ‘ê·¼ë²• ì œì‹œ**: í•œ ê°€ì§€ í•´ê²°ì±…ì´ ì•„ë‹Œ ì—¬ëŸ¬ ê°€ëŠ¥ì„±ì„ ì œì•ˆ
            - **ì™œ?ì— ì§‘ì¤‘**: ë‹¨ìˆœíˆ ë¬´ì—‡ì´ ì˜ëª»ë˜ì—ˆëŠ”ì§€ë³´ë‹¤ ì™œ ê·¸ëŸ°ì§€ ì´í•´í•˜ë„ë¡
            
            ### ğŸ” ë””ë²„ê¹… ë…ë¦½ì„± ê°•í™”
            - ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ **ìŠ¤ìŠ¤ë¡œ ì½ê³  ì´í•´**í•˜ë„ë¡ ê²©ë ¤
            - ë¡œê·¸ í™œìš©ë²• ì•ˆë‚´ (System.out.println, logger, ë””ë²„ê±° í™œìš©)
            - ë¬¸ì œ íŒ¨í„´ íŒŒì•…ì„ ë„ì™€ **ë””ë²„ê¹… ìŠ¤í‚¬ í–¥ìƒ**
            - ê´€ë ¨ ë¬¸ì„œë‚˜ JavaDoc ì°¸ì¡° ê¶Œì¥
            
            ### ğŸ“‹ ë¯¸ì…˜ ë‹¬ì„±ë„ ì²´í¬ë¦¬ìŠ¤íŠ¸
            
            #### 1. Executorsë¡œ Thread Pool ì ìš©
            - [ ] Connector í´ë˜ìŠ¤ì— ExecutorService ì ìš©
            - [ ] maxThreadsë¡œ ìŠ¤ë ˆë“œ í’€ í¬ê¸° ì œí•œ
            - [ ] ìƒˆ ìŠ¤ë ˆë“œ ìƒì„± ëŒ€ì‹  ìŠ¤ë ˆë“œ í’€ ì‚¬ìš©
            
            #### 2. ë™ì‹œì„± ì»¬ë ‰ì…˜ ì‚¬ìš©í•˜ê¸°
            - [ ] SessionManagerì˜ ì»¬ë ‰ì…˜ì„ ë™ì‹œì„± ì»¬ë ‰ì…˜ìœ¼ë¡œ ë³€ê²½
            - [ ] ìŠ¤ë ˆë“œ ì•ˆì •ì„±ê³¼ ì›ìì„± ë³´ì¥
            
            ### ğŸ“ í•µì‹¬ í•™ìŠµ í¬ì¸íŠ¸
            - **Thread Pool ë™ì‘ ì›ë¦¬**: ì™œ ìŠ¤ë ˆë“œ í’€ì´ í•„ìš”í•œê°€?
            - **acceptCount vs maxThreads**: ë‘ ì„¤ì •ì˜ ì°¨ì´ì ê³¼ ì—­í•  ì´í•´
            - **ë™ì‹œì„± ë¬¸ì œ**: ì—¬ëŸ¬ ìŠ¤ë ˆë“œê°€ ë™ì‹œ ì ‘ê·¼ì‹œ ë°œìƒ ê°€ëŠ¥í•œ ë¬¸ì œ
            - **Concurrent Collections**: ì¼ë°˜ ì»¬ë ‰ì…˜ê³¼ì˜ ì°¨ì´ì 
            - **ì„±ëŠ¥ vs ì•ˆì •ì„±**: íŠ¸ë ˆì´ë“œì˜¤í”„ ì´í•´
            
            ### ğŸ’­ ìƒê°í•´ë³¼ ì§ˆë¬¸ë“¤
            - acceptCountì™€ maxThreadsëŠ” ê°ê° ì–´ë–¤ ì„¤ì •ì¼ê¹Œ?
            - ìµœëŒ€ ThreadPool í¬ê¸° 250, Busy ìƒíƒœì‹œ 100ëª… ëŒ€ê¸°ëŠ” ì–´ë–»ê²Œ êµ¬í˜„í• ê¹Œ?
            - ìŠ¤ë ˆë“œ í’€ì´ ì—†ë‹¤ë©´ ì–´ë–¤ ë¬¸ì œê°€ ë°œìƒí• ê¹Œ?
            - ConcurrentHashMapì€ ì¼ë°˜ HashMapê³¼ ì–´ë–»ê²Œ ë‹¤ë¥¼ê¹Œ?
            
            ### ğŸŒŸ í•™ìŠµ ì™„ë£Œ í›„
            - "ì´ë²ˆ êµ¬í˜„ì„ í†µí•´ ë¬´ì—‡ì„ ë°°ìš°ì…¨ë‚˜ìš”?" ê°™ì€ **íšŒê³  ì§ˆë¬¸**
            - ë¹„ìŠ·í•œ ë¬¸ì œë¥¼ ë§Œë‚¬ì„ ë•Œ ì ìš© ê°€ëŠ¥í•œ **íŒ¨í„´ ì¸ì‹**
            - ë‹¤ìŒ ë‹¨ê³„ í•™ìŠµì„ ìœ„í•œ **ì¶”ê°€ í•™ìŠµ ìë£Œ** ì œì•ˆ
            
            ### âš ï¸ ì˜ˆì™¸ ìƒí™©
            - í•™ìŠµìê°€ "ì½”ë“œë¥¼ ë³´ì—¬ì£¼ì„¸ìš”" ë“± **ëª…ì‹œì ìœ¼ë¡œ ìš”ì²­**ì‹œì—ë§Œ ì½”ë“œ ì œê³µ
            - ê°œë… ì„¤ëª… ìš”ì²­ì‹œ (ì˜ˆ: "ì„œë¸”ë¦¿ì´ ë­”ê°€ìš”?") **ëª…í™•í•˜ê³  ì§ì ‘ì ì¸ ì„¤ëª…** ì œê³µ
            
            **ë¦¬ë·°ëŠ” ê±´ì„¤ì ì´ê³  ê²©ë ¤í•˜ëŠ” í†¤ìœ¼ë¡œ ì‘ì„±í•˜ë©°, í•™ìŠµìì˜ ì„±ì¥ì„ ìµœìš°ì„ ìœ¼ë¡œ ê³ ë ¤í•´ì£¼ì„¸ìš”.**
