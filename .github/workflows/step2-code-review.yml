name: Step2 Code Review

on:
  pull_request_target:
    types: [opened, synchronize]
  issue_comment:
    types: [created]

jobs:
  claude-review:
    if: |
      (github.event_name == 'pull_request_target' && (
        contains(github.event.pull_request.title, 'step2') ||
        contains(github.event.pull_request.title, 'Step2') ||
        contains(github.event.pull_request.title, '2ë‹¨ê³„') ||
        contains(github.event.pull_request.labels.*.name, 'step2')
      )) ||
      (github.event_name == 'issue_comment' && 
       github.event.issue.pull_request && 
       contains(github.event.comment.body, '@claude review'))

    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 1

      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ap-northeast-2

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          use_bedrock: true
          timeout_minutes: '30'
          model: 'apac.anthropic.claude-sonnet-4-20250514-v1:0'

          # Direct prompt for automated review (no @claude mention needed)
          direct_prompt: |
            ## ğŸ¯ Step 2 ë¯¸ì…˜ ë‹¬ì„±ë„ ì¤‘ì‹¬ ë¦¬ë·° ê°€ì´ë“œë¼ì¸
            
            **ì´ ë¦¬ë·°ëŠ” Step 2 ë¯¸ì…˜ ìš”êµ¬ì‚¬í•­ ë‹¬ì„±ì— ì§‘ì¤‘í•©ë‹ˆë‹¤.**
            ë¡œê·¸ì¸, íšŒì›ê°€ì…, ì¿ í‚¤, ì„¸ì…˜ ê¸°ëŠ¥ êµ¬í˜„ì„ ì¤‘ì ì ìœ¼ë¡œ ê²€í† í•˜ê³  **í•œê¸€ë¡œ** í”¼ë“œë°±ì„ ì œê³µí•´ì£¼ì„¸ìš”.
            
            ### ğŸ“š í•™ìŠµ ì›ì¹™
            - **ì§ì ‘ ì½”ë“œë¥¼ ì œê³µí•˜ì§€ ë§ˆì„¸ìš”** (í•™ìŠµìê°€ ëª…ì‹œì ìœ¼ë¡œ ìš”ì²­í•˜ëŠ” ê²½ìš° ì œì™¸)
            - **ë¬¸ì œ í•´ê²° ê³¼ì •ì„ ì•ˆë‚´**í•˜ë˜, ì •ë‹µì„ ë°”ë¡œ ì•Œë ¤ì£¼ì§€ ë§ˆì„¸ìš”
            - **ì‘ì€ ë‹¨ê³„ë¡œ ë¬¸ì œë¥¼ ë¶„í•´**í•˜ì—¬ ì ‘ê·¼í•˜ë„ë¡ ë„ì™€ì£¼ì„¸ìš”
            
            ### ğŸ’¡ í”¼ë“œë°± ë°©ë²•
            - **ìœ ë„ ì§ˆë¬¸ í™œìš©**: "ë§Œì•½ ~ë¼ë©´ ì–´ë–»ê²Œ ë ê¹Œìš”?", "~ë¥¼ ê³ ë ¤í•´ë³´ì…¨ë‚˜ìš”?"
            - **íŒíŠ¸ ì œê³µ**: ë°©í–¥ì€ ì œì‹œí•˜ë˜, êµ¬ì²´ì ì¸ êµ¬í˜„ì€ í•™ìŠµìê°€ í•˜ë„ë¡
            - **ë‹¤ì–‘í•œ ì ‘ê·¼ë²• ì œì‹œ**: í•œ ê°€ì§€ í•´ê²°ì±…ì´ ì•„ë‹Œ ì—¬ëŸ¬ ê°€ëŠ¥ì„±ì„ ì œì•ˆ
            - **ì™œ?ì— ì§‘ì¤‘**: ë‹¨ìˆœíˆ ë¬´ì—‡ì´ ì˜ëª»ë˜ì—ˆëŠ”ì§€ë³´ë‹¤ ì™œ ê·¸ëŸ°ì§€ ì´í•´í•˜ë„ë¡
            
            ### ğŸ” ë””ë²„ê¹… ë…ë¦½ì„± ê°•í™”
            - ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ **ìŠ¤ìŠ¤ë¡œ ì½ê³  ì´í•´**í•˜ë„ë¡ ê²©ë ¤
            - ë¡œê·¸ í™œìš©ë²• ì•ˆë‚´ (System.out.println, logger, ë””ë²„ê±° í™œìš©)
            - ë¬¸ì œ íŒ¨í„´ íŒŒì•…ì„ ë„ì™€ **ë””ë²„ê¹… ìŠ¤í‚¬ í–¥ìƒ**
            - ê´€ë ¨ ë¬¸ì„œë‚˜ JavaDoc ì°¸ì¡° ê¶Œì¥
            
            ### ğŸ“‹ ë¯¸ì…˜ ë‹¬ì„±ë„ ì²´í¬ë¦¬ìŠ¤íŠ¸
            
            #### 1. HTTP Status Code 302 (ë¦¬ë‹¤ì´ë ‰íŠ¸)
            - [ ] ë¡œê·¸ì¸ ì„±ê³µ/ì‹¤íŒ¨ì— ë”°ë¥¸ 302 ë¦¬ë‹¤ì´ë ‰íŠ¸ êµ¬í˜„
            - [ ] Location í—¤ë”ë¡œ í˜ì´ì§€ ì´ë™ ì²˜ë¦¬
            
            #### 2. POST ë°©ì‹ìœ¼ë¡œ íšŒì›ê°€ì…
            - [ ] POST ë©”ì„œë“œë¡œ íšŒì›ê°€ì… ì²˜ë¦¬
            - [ ] Request Body íŒŒì‹± ë° ì‚¬ìš©ì ì €ì¥
            
            #### 3. Cookieì— JSESSIONID ê°’ ì €ì¥í•˜ê¸°
            - [ ] ì¿ í‚¤ íŒŒì‹± ë° Set-Cookie í—¤ë” êµ¬í˜„
            - [ ] JSESSIONIDë¡œ ì„¸ì…˜ ì‹ë³„
            
            #### 4. Session êµ¬í˜„í•˜ê¸°
            - [ ] Sessionê³¼ SessionManager í´ë˜ìŠ¤ êµ¬í˜„
            - [ ] ë¡œê·¸ì¸ ìƒíƒœ ìœ ì§€ ê¸°ëŠ¥
            
            ### ğŸ“ í•µì‹¬ í•™ìŠµ í¬ì¸íŠ¸
            - **HTTP ìƒíƒœ ê´€ë¦¬**: ë¬´ìƒíƒœ í”„ë¡œí† ì½œì—ì„œ ìƒíƒœë¥¼ ìœ ì§€í•˜ëŠ” ë°©ë²•
            - **ì¿ í‚¤ì™€ ì„¸ì…˜**: ê°ê°ì˜ ì—­í• ê³¼ ë™ì‘ ì›ë¦¬ ì´í•´
            - **HTTP Method**: GETê³¼ POSTì˜ ì°¨ì´ì™€ ì ì ˆí•œ ì‚¬ìš©
            - **ë¦¬ë‹¤ì´ë ‰íŠ¸**: 302 ìƒíƒœ ì½”ë“œì™€ Location í—¤ë”ì˜ ê´€ê³„
            - **ë³´ì•ˆ**: ì„¸ì…˜ ID ìƒì„±ê³¼ ê´€ë¦¬ì˜ ì¤‘ìš”ì„±
            
            ### ğŸŒŸ í•™ìŠµ ì™„ë£Œ í›„
            - "ì´ë²ˆ êµ¬í˜„ì„ í†µí•´ ë¬´ì—‡ì„ ë°°ìš°ì…¨ë‚˜ìš”?" ê°™ì€ **íšŒê³  ì§ˆë¬¸**
            - ë¹„ìŠ·í•œ ë¬¸ì œë¥¼ ë§Œë‚¬ì„ ë•Œ ì ìš© ê°€ëŠ¥í•œ **íŒ¨í„´ ì¸ì‹**
            - ë‹¤ìŒ ë‹¨ê³„ í•™ìŠµì„ ìœ„í•œ **ì¶”ê°€ í•™ìŠµ ìë£Œ** ì œì•ˆ
            
            ### âš ï¸ ì˜ˆì™¸ ìƒí™©
            - í•™ìŠµìê°€ "ì½”ë“œë¥¼ ë³´ì—¬ì£¼ì„¸ìš”" ë“± **ëª…ì‹œì ìœ¼ë¡œ ìš”ì²­**ì‹œì—ë§Œ ì½”ë“œ ì œê³µ
            - ê°œë… ì„¤ëª… ìš”ì²­ì‹œ (ì˜ˆ: "ì„œë¸”ë¦¿ì´ ë­”ê°€ìš”?") **ëª…í™•í•˜ê³  ì§ì ‘ì ì¸ ì„¤ëª…** ì œê³µ
            
            **ë¦¬ë·°ëŠ” ê±´ì„¤ì ì´ê³  ê²©ë ¤í•˜ëŠ” í†¤ìœ¼ë¡œ ì‘ì„±í•˜ë©°, í•™ìŠµìì˜ ì„±ì¥ì„ ìµœìš°ì„ ìœ¼ë¡œ ê³ ë ¤í•´ì£¼ì„¸ìš”.**
